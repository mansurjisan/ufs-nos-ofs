#!/bin/bash
set -xa

########################################
# NOS_OFS_PREP 
########################################
export PS4='$SECONDS + '
date
export LD_PRELOAD=/usrx/local/prod/packages/ips/18.0.1/netcdf/4.5.0/lib/libnetcdff.so.6:${LD_PRELOAD}

###################################
# Specify NET and RUN Name and model
####################################
export OFS=${OFS:-ngofs}
export NET=${NET:-nos}
export RUN=${RUN:-$OFS}
export platform=${platform:-Phase1}
###############################################################
# This block can be modified for different Production test
# environment. This is used for operational testings
###############################################################
if [ $envir != prod ]; then
  export SENDCOM=NO
  export SENDDBN=NO
  export SENDSMS=NO
  if [ $platform == 'Phase1' ]; then
    export HOMEnos=/nos/save/$LOGNAME/nwprod/nosofs.${nosofs_ver}
    export DATAROOT=/ptmpp1/$LOGNAME/${OFS}/work    #  NOS OFS Development Running
    export COMOUTroot=/ptmpp1/$LOGNAME/${OFS}/${envir}             # output directory
  elif  [ $platform == 'Phase2' ]; then
    export HOMEnos=/nos2/noscrub/$LOGNAME/nwprod2/nosofs.${nosofs_ver}
    export DATAROOT=/ptmpp2/$LOGNAME/${OFS}/work
    export COMOUTroot=/ptmpp2/$LOGNAME/${OFS}/${envir}
  elif  [[ $platform == Dell* ]]; then
    export HOMEnos=/gpfs/dell2/nos/noscrub/$LOGNAME/nwprod/nosofs.${nosofs_ver}
    export DATAROOT=/gpfs/${platform,,}/ptmp/$LOGNAME/${OFS}/work
    export COMOUTroot=/gpfs/${platform,,}/ptmp/$LOGNAME/${OFS}/${envir}
  fi
#  export COMOUTroot=${COMOUTroot1}/${OFS}/${envir}
  export FTP=tidepool.nos.noaa.gov
  export FTPDIR=/pub/incoming/NCEP_OFS/${OFS}
#  export COMINnestedparent=/gpfs/?p2/nco/ops/com/nos/prod  # use operational NGOFS
  export COMINnestedparent=/gpfs/${platform,,}/ptmp/$LOGNAME/ngofs/dev
  if [ "${OFS,,}" == "wcofs4-da" ]; then
    export OFS_NF='wcofs'
    export COMrst=${COMOUTroot1}/${OFS_NF}/${envir}
  fi
fi

###############################################################
# Specify DBN_ALERT_TYPE_???? for different Production envir.
###############################################################
export DBN_ALERT_TYPE_NETCDF=${DBN_ALERT_TYPE_NETCDF:-NOS_OFS_FCST_NETCDF}
export DBN_ALERT_TYPE_TEXT=${DBN_ALERT_TYPE_TEXT:-NOS_OFS_FCST_TEXT}

####################################
# obtain unique process id (pid) and make temp directory
####################################
export pid=$$
export cycle=t${cyc}z

########################################################
# Make working directory
########################################################
rm -rf ${DATAROOT}/*  #  For development
export DATA=${DATA:-$DATAROOT/${job}.${pid}}
#  rm -rf ${DATAROOT}/*  #  For development
if [ ! -d $DATA ]; then
  mkdir -p $DATA
  cd $DATA
else
  cd $DATA
  rm -fr $DATA/*
fi

############################################
#   Determine Job Output Name on System
############################################
export outid="LL$job"
export jobid="${outid}.o${pid}"
export pgmout="OUTPUT.${pid}"

####################################
# SENDSMS  - Flag Events on SMS
# SENDCOM  - Copy files to /com directory
####################################
# MOVED INTO envir.h
#export SENDSMS=${SENDSMS:-YES}
#export SENDCOM=${SENDCOM:-YES}
#export SENDDBN=${SENDDBN:-YES}

####################################
# Specify Execution Areas
####################################
export HOMEnos=${HOMEnos:-${NWROOT:?}/${model}.${nosofs_ver}}
export EXECnos=${EXECnos:-${HOMEnos}/exec}
export FIXnos=${FIXnos:-${HOMEnos}/fix/shared}
export FIXofs=${FIXofs:-${HOMEnos}/fix/${OFS}}
export PARMnos=${PARMnos:-${HOMEnos}/parm}
export USHnos=${USHnos:-${HOMEnos}/ush}
export SCRIPTSnos=${SCRIPTSnos:-${HOMEnos}/scripts}

###################################
# Set up the UTILITIES
###################################
export UTILROOT=${UTILROOT:-/gpfs/dell1/nco/ops/nwprod/prod_util.v1.1.0}
export utilscript=${utilscript:-$UTILROOT/ush}
export utilexec=${utilexec:-$UTILROOT/exec}
export utilities=${utilities:-$UTILROOT/ush}
###############################################################
# Load modules to initialize working directory and utility scripts
# This should be done in the SUBMIT SCRIPT
###############################################################
#$utilscript/setup.sh
###########################################
# Run setpdy and initialize PDY variables
###########################################
#sh setpdy.sh
setpdy.sh
. ./PDY
#export PDY=20180713


##############################################
# Define COM directories
##############################################
##export COMROOT=${COMROOT:-/gpfs/dell1/nco/ops/com}
##export COMROOTp1=${COMROOTp1:-/gpfs/?p1/nco/ops/com}
##export COMROOTp2=${COMROOTp2:-/gpfs/?p2/nco/ops/com}
##export DCOMROOT=${DCOMROOT:-/gpfs/?p1/nco/ops/dcom}
#export COMIN=${COMIN:-${COMROOT}/${NET}/${envir}/${RUN}.${PDY}}   # input directory
##export COMOUTroot=${COMOUTroot:-${COMROOT}/${NET}/${envir}}       # output directory
##export COMOUT=${COMOUT:-${COMOUTroot}/${RUN}.${PDY}}              # output directory
#export COMOUTcorms=${COMOUTcorms:-${COMOUTroot}/${RUN}.${PDY}}    # output directory
#  export COMINparent=/com/nos/prod   # change this parameter if parent and child models are not run at same stage
export COMINnestedparent=${COMINnestedparent:-${COMOUTroot}}

mkdir -m 775 -p $COMOUT $COMOUTcorms

###########################  machuan added the following
export COMROOT=${COMROOT:-/gpfs/dell1/nco/ops/com}
export COMROOTp1=${COMROOTp1:-/gpfs/?p1/nco/ops/com}
export COMROOTp2=${COMROOTp2:-/gpfs/?p2/nco/ops/com}
export DCOMROOT=${DCOMROOT:-/gpfs/?p1/nco/ops/dcom}

export COMIN=${COMIN:-${COMROOT}/${NET}/${envir}/${RUN}.${PDY}}   # input directory
export COMOUTroot=${COMOUTroot:-${COMROOT}/${NET}/${envir}}       # output directory
export COMOUT=${COMOUT:-${COMOUTroot}/${RUN}.${PDY}}              # output directory
export COMOUTcorms=${COMOUTcorms:-${COMOUTroot}/${RUN}.${PDY}}    # output directory





###################







##############################################
### Set up input data path
##############################################

export COMINnam=${COMINnam:-$(compath.py nam/prod/)}
export COMINhrrr=${COMINhrrr:-$(compath.py hrrr/prod/)}
export COMINrap=${COMINrap:-$(compath.py rap/prod/)}
export COMINgfs=${COMINgfs:-$(compath.py gfs/prod/)}
export COMINrtma=${COMINrtma:-$(compath.py rtma/prod/)}
export COMINetss=${COMINetss:-$(compath.py etss/prod/)}
export COMINrtofs_2d=${COMINrtofs_2d:-$(compath.py rtofs/prod/)}
export COMINrtofs_3d=${COMINrtofs_3d:-$(compath.py rtofs/prod/)}

if [ ${RUN} == "NEGOFS" -o ${RUN} == "negofs" -o ${RUN} == "NWGOFS" -o ${RUN} == "nwgofs" ]
then
  export NESTED_PARENT_OFS=ngofs
fi

export DCOMINndfd=${DCOMROOT}/us007003
export DCOMINncom=${DCOMROOT}/us007003
export DCOMINusgs=${DCOMROOT}/us007003
export DCOMINports=${DCOMROOT}/us007003
export NOSBUFR=xx012
export USGSBUFR=xx009

##################################################################
####  Log File To Sys Report  
##################################################################
export jlogfile=$DATA/${NET}.${RUN}.jlog.${PDY}.${cycle}.log
export nosjlogfile=${COMOUT}/${NET}.${RUN}.jlogfile.${PDY}.${cycle}.log 

##################################################################
####  Log File To COMOUTcorms
##################################################################
export cormslogfile=${COMOUT}/${NET}.${RUN}.corms.${PDY}.${cycle}.log

env  

########################################################
# Execute the script.
########################################################
#   echo "Generating the preparation"

$SCRIPTSnos/exnos_grib2_prep.sh 


#$SCRIPTSnos/exnos_ofs_prep.sh.mpmd  $OFS
########################################################

cat $pgmout

msg="JOB $job HAS ENDED NORMALLY."
postmsg "$jlogfile" "$msg"

##############################
# Remove the Temporary working directory
##############################
#cd $DATAROOT
#if [ "$KEEPDATA" != YES ]; then
# rm -rf $DATA
#fi

date


